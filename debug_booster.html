<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>DEBUG Booster Chat</title>
    <style>
        body {
            background: #111;
            color: white;
            font-family: sans-serif;
            padding: 20px;
        }

        .btn {
            padding: 10px 20px;
            cursor: pointer;
            background: #00d1b2;
            border: none;
            color: white;
            font-weight: bold;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #222;
            padding: 20px;
            width: 400px;
            height: 500px;
            display: flex;
            flex-direction: column;
            border: 1px solid #444;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: #333;
            margin-bottom: 10px;
            padding: 10px;
        }

        .chat-input {
            padding: 10px;
            background: #111;
            border: 1px solid #555;
            color: white;
            width: 100%;
        }
    </style>
</head>

<body>

    <h1>DEBUG MODE: Booster Chat</h1>
    <p>Este é um teste isolado para verificar se o chat abre.</p>

    <div id="auth-status">Verificando login...</div>

    <div id="orders-container" style="margin-top:20px;"></div>

    <!-- CHAT MODAL -->
    <div class="modal-overlay" id="modal-chat">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <h3 class="modal-title" style="margin:0;">Chat</h3>
                <button onclick="closeChat()" style="background:red;color:white;border:none;cursor:pointer;">X</button>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <input type="text" class="chat-input" id="chat-input" placeholder="Digite..."
                onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn" onclick="sendMessage()" style="margin-top:5px;width:100%">Enviar</button>
        </div>
    </div>

    <script>
        const API = '/api';
        let token = localStorage.getItem('elodark_token');
        let currentOrderId = null;
        let interval = null;

        // 1. Check Auth manually
        if (!token) {
            document.getElementById('auth-status').innerHTML = '<span style="color:red">SEM TOKEN! Faça login na página principal primeiro.</span>';
        } else {
            document.getElementById('auth-status').innerHTML = '<span style="color:green">Token encontrado. Buscando pedidos...</span>';
            loadOrders();
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/orders', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                if (data.orders) {
                    const html = data.orders.map(o => `
                        <div style="border:1px solid #444; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                            <span>Pedido #${o.id} - ${o.service_type} (${o.status})</span>
                            <button class="btn" onclick="openChat(${o.id})">ABRIR CHAT</button>
                        </div>
                    `).join('');
                    document.getElementById('orders-container').innerHTML = html;
                } else {
                    document.getElementById('orders-container').innerText = 'Nenhum pedido encontrado ou erro de API.';
                }
            } catch (e) {
                document.getElementById('orders-container').innerText = 'Erro ao buscar pedidos: ' + e.message;
            }
        }

        window.openChat = function (id) {
            console.log('Opening chat for', id);
            currentOrderId = id;
            document.getElementById('modal-chat').style.display = 'flex';
            document.querySelector('.modal-title').innerText = 'Chat Pedido #' + id;
            loadMessages();
            if (interval) clearInterval(interval);
            interval = setInterval(loadMessages, 3000);
        }

        window.closeChat = function () {
            document.getElementById('modal-chat').style.display = 'none';
            if (interval) clearInterval(interval);
        }

        async function loadMessages() {
            if (!currentOrderId) return;
            try {
                const res = await fetch('/api/chat/' + currentOrderId, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                const msgs = data.messages || [];

                document.getElementById('chat-messages').innerHTML = msgs.map(m => `
                    <div style="margin-bottom:5px; text-align: ${m.user_id == getUserId() ? 'right' : 'left'}">
                        <span style="background: ${m.user_id == getUserId() ? '#007766' : '#444'}; padding:5px 10px; border-radius:5px; display:inline-block;">
                            ${m.content}
                            <div style="font-size:0.7em; opacity:0.7">${m.sender_name || 'User'}</div>
                        </span>
                    </div>
                `).join('');
            } catch (e) {
                console.error(e);
            }
        }

        async function sendMessage() {
            const txt = document.getElementById('chat-input').value;
            if (!txt || !currentOrderId) return;

            await fetch('/api/chat/' + currentOrderId, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: txt })
            });
            document.getElementById('chat-input').value = '';
            loadMessages();
        }

        function getUserId() {
            try {
                return JSON.parse(atob(token.split('.')[1])).id;
            } catch { return 0; }
        }
    </script>
</body>

</html>